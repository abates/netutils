---
name: "Docker Build"
description: "This action builds a docker image to be used for testing."
inputs:
  python-version:
    description: "Python version that will be deployed"
    required: false
    default: "3.9"

runs:
  using: "composite"
  env:
    PYTHON_VER: "${{ inputs.python-version }}"
  steps:
    - name: "Setup environment"
      uses: "./.github/actions/setup-env"
      with:
        python-version: "${{ inputs.python-version }}"
    - name: "Get image version"
      run: "echo IMAGE_VER=`poetry version -s`-py${{ inputs.python-version }} >> $GITHUB_ENV"
    - name: "Set up Docker Buildx"
      id: "buildx"
      uses: "docker/setup-buildx-action@v2"
    - name: "Debug: Show docker images before build"
      run: "docker image ls"
    - name: "Build"
      uses: "docker/build-push-action@v3"
      with:
        load: true
        push: false
        tags: "${{ env.IMAGE_NAME }}:${{ env.IMAGE_VER }}"
        file: "./Dockerfile"
        cache-from: "type=gha,scope=${{ env.IMAGE_NAME }}-${{ env.IMAGE_VER }}-py${{ inputs.python-version }}"
        cache-to: "type=gha,scope=${{ env.IMAGE_NAME }}-${{ env.IMAGE_VER }}-py${{ inputs.python-version }}"
        build-args: |
          PYTHON_VER=${{ env.PYTHON_VER }}
    - name: "Debug: Show docker images"
      run: "docker image ls"
